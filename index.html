<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ochart â€” visualizador</title>
  <link rel="icon" href="data:image/svg+xml,
<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22>
  <text x=%224%22 y=%2212%22 font-size=%2212%22>ðŸ“ˆ</text>
</svg>">

  <!-- NÃºcleo Chart.js e plugins (UMD) -->
  <script src="./libs/chart.umd.js"></script>
  <script src="./libs/chartjs-adapter-date-fns.bundle.js"></script>
  <script src="./libs/chartjs-chart-financial.min.js"></script>
  <script src="./libs/chartjs-plugin-zoom.min.js"></script>
  <script src="./libs/chartjs-plugin-annotation.min.js"></script>

  <!-- Polimento visual padrÃ£o do Chart.js (IIFE) - mantÃ©m caminho existente -->
  <script src="./js/content.js"></script>

  <style>
    /* TransiÃ§Ã£o suave para mudanÃ§a de tema */
    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:20px; background:var(--theme-surface, #f8fafc)}
    .box{border:1px solid var(--theme-border, #e5e7eb); border-radius:10px; padding:12px; background:var(--theme-surface-alt, #fff); box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--theme-text-muted, #6b7280); font-size:12px}
    .big{font-size:20px; font-weight:600; color:var(--theme-text, #111827)}
    #dev-hud-root{position:fixed; left:0; right:0; bottom:0; z-index:40}
    .inline{display:inline-flex; gap:6px; align-items:center}
    button, select{cursor:pointer; background:var(--theme-surface-alt, #fff); color:var(--theme-text, #111827); border:1px solid var(--theme-border, #e5e7eb); padding:6px 10px; border-radius:6px}
    select{padding:4px 8px}
    .spacer{flex:1 1 auto}
    .seg{display:inline-flex; border:1px solid var(--theme-border, #d1d5db); border-radius:10px; overflow:hidden}
    .seg button{padding:6px 10px; background:var(--theme-surface-alt, #fff); border:0; border-radius:0}
    .seg button.active{background:var(--theme-button-active, #111827); color:var(--theme-surface, #fff)}
    .badge{font-size:12px; color:var(--theme-text-muted, #374151); background:var(--theme-border, #e5e7eb); padding:2px 6px; border-radius:6px}
    /* Adiciona prefixo de dÃ³lar para os valores */
    .price-value:before { content: "$"; }
    
    /* Tema dark especÃ­fico */
    [data-theme="dark"] {
      --theme-surface: #0f111a;
      --theme-surface-alt: #1a1d2e;
      --theme-border: #2a2d3a;
      --theme-text: #e4e4e7;
      --theme-text-muted: #9ca3af;
      --theme-button-active: #3b82f6;
    }
    
    /* Tema light especÃ­fico */
    [data-theme="light"] {
      --theme-surface: #ffffff;
      --theme-surface-alt: #f8fafc;
      --theme-border: #e5e7eb;
      --theme-text: #111827;
      --theme-text-muted: #6b7280;
      --theme-button-active: #111827;
    }
  </style>
  <!-- MantÃ©m seu CSS no caminho atual -->
  <link rel="stylesheet" href="./assets/app.css">
</head>
<body class="ui-surface">

  <section class="box row">
    <div class="inline">
      <label>TF</label>
      <select id="sel-tf">
        <option value="1h">1h</option>
        <option value="1d" selected>1d</option>
        <option value="1w">1w</option>
        <option value="1mo">1mo</option>
      </select>
    </div>

    <div class="inline">
      <label class="muted">Janela (offsets do fim)</label>
      <div id="ow"></div>
    </div>

    <div class="inline">
      <label class="muted">Tipo</label>
      <div class="seg">
        <button id="btn-type-line" class="active">Line</button>
        <button id="btn-type-candle">Candle</button>
      </div>
    </div>

    <div class="inline">
      <label class="muted">Escala</label>
      <div class="seg">
        <button id="btn-scale-linear">Linear</button>
        <button id="btn-scale-log" class="active">Log</button>
      </div>
    </div>

    <div class="spacer"></div>

    <button id="btn-table">Tabela</button>
    <button id="btn-sync">Sync</button>
    <span id="status" class="muted">â€”</span>
  </section>

  <section class="box" style="height:420px; margin-top:12px">
    <canvas id="ch"></canvas>
  </section>

  <section class="box row" style="margin-top:12px">
    <div><div class="muted">PreÃ§o (close)</div><div id="k-close" class="big price-value">â€”</div></div>
    <div><div class="muted">MÃ¡x (janela)</div><div id="k-max" class="big price-value">â€”</div></div>
    <div><div class="muted">MÃ­n (janela)</div><div id="k-min" class="big price-value">â€”</div></div>
  </section>

  <div id="dev-hud-root"></div>

  <script type="module">
    import { ChartEngine } from './src/core/chart-engine.js';
    import { mountHUD, pushLog } from './src/ui/dev-hud.js';
    import { sanitizeLine } from './src/core/sanitizer.js';
    import { OffsetWindow } from './src/ui/offset-window.js';
    import { TableModal } from './src/ui/table-modal.js';
    import { themeManager } from './src/ui/theme-manager.js';

    mountHUD(document.getElementById('dev-hud-root'));

    const $ = (sel)=> document.querySelector(sel);
    let engine = null;
    let ow = null;
    let fullRows = [];
    let currentRows = [];
    let currentScale = 'logarithmic';
    let currentType  = 'line';
    const tableModal = new TableModal();

    // Inicializa o gerenciador de temas
    themeManager.init();
    themeManager.createThemeToggle();
    
    // Callback quando o tema muda
    themeManager.on('onThemeChange', (theme) => {
      pushLog({ level:'info', msg:'theme_change', ts: Date.now(), data:{ theme }});
      // Se o grÃ¡fico existir, recria com novo tema
      if (engine && currentRows.length > 0) {
        render(currentRows);
      }
    });

    // FunÃ§Ã£o para formatar valores em dÃ³lares sem decimais
    function formatPrice(value) {
      if (!Number.isFinite(value)) return 'â€”';
      return Math.round(value).toLocaleString('en-US');
    }

    function mapInterval(tf){
      if (tf === '1h') return '60m';
      if (tf === '1w') return '1wk';
      return tf;
    }
    function requestRange(tf){
      if (tf === '1h')  return '3mo';
      if (tf === '1d')  return 'max';
      if (tf === '1w')  return 'max';
      if (tf === '1mo') return 'max';
      return 'max';
    }

    async function fetchSeries(tf='1d'){
      const interval = mapInterval(tf);
      const range = requestRange(tf);
      const pos = (currentScale === 'logarithmic') ? '1' : '0';
      const url = `./api/yahoo.php?symbol=BTC-USD&interval=${encodeURIComponent(interval)}&range=${encodeURIComponent(range)}&sanitized=1&pos=${pos}`;
      const res = await fetch(url, { headers: { 'Accept':'application/json' }, cache:'no-store' });

      const xCache = (res.headers.get('X-Cache') || 'UNKNOWN').toUpperCase();
      const xAge   = +(res.headers.get('X-Cache-Age') || 0);
      const xTtl   = +(res.headers.get('X-Cache-TTL') || 0);
      const xAdj   = (res.headers.get('X-Range-Adjusted') || '0') === '1';
      const xInt   = res.headers.get('X-Interval') || interval;
      const xRng   = res.headers.get('X-Range')    || range;
      const xSan   = res.headers.get('X-Sanitized') || '0';

      const style  = xCache==='HIT' ? 'background:#16a34a;color:#fff;padding:2px 6px;border-radius:4px'
                    : xCache==='MISS' ? 'background:#2563eb;color:#fff;padding:2px 6px;border-radius:4px'
                    : xCache==='STALE'? 'background:#d97706;color:#fff;padding:2px 6px;border-radius:4px'
                    : xCache==='BYPASS'? 'background:#0ea5e9;color:#fff;padding:2px 6px;border-radius:4px'
                    : 'background:#6b7280;color:#fff;padding:2px 6px;border-radius:4px';
      const fmt = s => !s||s<0 ? '0s' : (Math.floor(s/3600)? `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m` : `${Math.floor((s%3600)/60)}m ${Math.floor(s%60)}s`);
      console.info(`%c${xCache}%c  interval=${xInt} â€¢ range=${xRng} â€¢ age=${fmt(xAge)} â€¢ ttl=${fmt(xTtl)}${xAdj?' â€¢ adjusted':''} â€¢ sanitized=${xSan}`, style,'color:inherit');
      pushLog({ level:'info', msg:'yahoo_cache', ts: Date.now(), data:{ cache:xCache, interval:xInt, range:xRng, age_s:xAge, ttl_s:xTtl, adjusted:xAdj, sanitized:xSan==='1' }});

      const text = await res.text();
      let payload = null;
      try {
        payload = text ? JSON.parse(text) : null;
      } catch (e) {
        console.error('Bad JSON from backend:', text?.slice(0, 400));
        pushLog({ level:'error', msg:'backend_bad_json', ts: Date.now(), data:{ snippet: (text||'').slice(0,200) }});
        throw new Error('Resposta invÃ¡lida da API (JSON malformado)');
      }

      if(!res.ok){
        const errMsg = (payload && (payload.message || payload.error)) ? (payload.message || payload.error) : `HTTP ${res.status}`;
        pushLog({ level:'error', msg:'yahoo_http_error', ts: Date.now(), data:{ status: res.status, error: errMsg, body: (text||'').slice(0,160) }});
        throw new Error(errMsg);
      }

      if (!payload || typeof payload !== 'object') {
        pushLog({ level:'error', msg:'empty_payload', ts: Date.now(), data:{} });
        throw new Error('Payload vazio da API');
      }

      pushLog({ level:'info', msg:'yahoo_fetch_ok', ts: Date.now(), data:{
        rows: Array.isArray(payload?.data) ? payload.data.length : 0,
        cache:xCache, interval:xInt, range:xRng, sanitized: !!payload?.meta?.sanitized
      }});

      if (payload?.meta?.sanitized && payload?.meta?.sanitize_report) {
        pushLog({ level:'info', msg:'sanitize_report_backend', ts: Date.now(), data: payload.meta.sanitize_report });
      }

      return payload;
    }

    function sliceByOffsets(rows, finish, start){
      const n = rows.length;
      if (!n) return { data: [], a:0, b:0, left:0, right:0 };
      const max = Math.max(0, n-1);
      const F = Math.min(Math.max(0, finish|0), max);
      const S = Math.min(Math.max(0, start|0),  max);
      const left  = Math.max(F, S);
      const right = Math.min(F, S);
      const idxStart = (n-1) - left;
      const idxEnd   = (n-1) - right;
      const a = Math.max(0, Math.min(idxStart, idxEnd));
      const b = Math.max(0, Math.max(idxStart, idxEnd));
      return { data: rows.slice(a, b+1), a, b, left, right };
    }

    function render(rows){
      if(!engine){
        engine = new ChartEngine($('#ch'));
        // Passa o engine para o theme manager
        themeManager.chartEngine = engine;
      }
      engine.create(rows, { type: currentType, scale: currentScale });
      
      // Aplica tema atual no grÃ¡fico
      const theme = themeManager.getCurrentTheme();
      if (theme) {
        themeManager.updateChartTheme(theme.colors);
      }
      
      currentRows = rows.slice();

      // Atualiza KPIs com valores formatados sem decimais
      const last = rows[rows.length-1];
      $('#k-close').textContent = formatPrice(last?.c);
      
      const highs = rows.map(r => r.h).filter(Number.isFinite);
      const lows  = rows.map(r => r.l).filter(Number.isFinite);
      $('#k-max').textContent = highs.length ? formatPrice(Math.max(...highs)) : 'â€”';
      $('#k-min').textContent = lows.length  ? formatPrice(Math.min(...lows))  : 'â€”';
    }

    function setScale(scale){
      currentScale = (scale === 'linear') ? 'linear' : 'logarithmic';
      document.getElementById('btn-scale-linear').classList.toggle('active', currentScale==='linear');
      document.getElementById('btn-scale-log').classList.toggle('active', currentScale==='logarithmic');
      if (engine) engine.setScale(currentScale);
      pushLog({ level:'info', msg:'scale_change', ts: Date.now(), data:{ scale: currentScale }});
      const tag = currentScale==='logarithmic' ? 'Log' : 'Linear';
      document.getElementById('status').textContent = `OK (${tag})`
    }

    function setType(type){
      currentType = (type === 'candlestick') ? 'candlestick' : 'line';
      document.getElementById('btn-type-line').classList.toggle('active', currentType==='line');
      document.getElementById('btn-type-candle').classList.toggle('active', currentType==='candlestick');
      if (engine) engine.setType(currentType);
      pushLog({ level:'info', msg:'chart_type_change', ts: Date.now(), data:{ type: currentType }});
      document.getElementById('status').textContent = `OK (${currentType === 'candlestick' ? 'Candle' : 'Line'})`;
    }

    async function sync(tf){
      document.getElementById('status').textContent = 'Carregando...';
      pushLog({ level:'info', msg:'sync_start', ts: Date.now(), data:{ tf, scale: currentScale }});
      try{
        const payload = await fetchSeries(tf);
        const data = Array.isArray(payload?.data) ? payload.data : [];
        const meta = payload?.meta || {};
        const { data: rows, stats } = sanitizeLine(data, { requirePositive: currentScale==='logarithmic' });
        fullRows = rows;
        pushLog({ level: (stats.droppedInvalid>0?'warn':'info'), msg:'sanitize_report_front', ts: Date.now(), data: stats });

        const max = Math.max(0, rows.length-1);
        const ensureOW = ()=>{
          if (!ow) {
            ow = new OffsetWindow(document.getElementById('ow'), {
              max, finish: max, start: 0,
              onApply: ({ max, finish, start })=>{
                const sliced = sliceByOffsets(fullRows, finish, start);
                pushLog({ level:'info', msg:'window_offsets', ts: Date.now(), data:{ max, finish, start, size: sliced.data.length, idxStart: sliced.a, idxEnd: sliced.b }});
                render(sliced.data);
                document.getElementById('status').textContent = `OK (janela: ${sliced.data.length})`;
              }
            });
          } else {
            ow.setMax(max);
            ow.setWindow({ finish: max, start: 0 });
          }
        };

        ensureOW();

        const sliced = sliceByOffsets(rows, Math.max(0, rows.length-1), 0);
        render(sliced.data);
        document.getElementById('status').textContent = `OK (${currentScale==='logarithmic'?'Log':'Linear'})`;
        pushLog({ level:'info', msg:'sync_ok', ts: Date.now(), data:{ bars: rows.length, scale: currentScale, backend_sanitized: !!meta?.sanitized }});
      }catch(e){
        console.error(e);
        document.getElementById('status').textContent = 'Falha';
        pushLog({ level:'error', msg:'sync_fail', ts: Date.now(), data:{ error: String(e) }});
        alert('Erro: ' + e.message);
      }
    }

    // Handlers
    document.getElementById('btn-scale-linear').addEventListener('click', ()=> setScale('linear'));
    document.getElementById('btn-scale-log').addEventListener('click',    ()=> setScale('logarithmic'));
    document.getElementById('btn-type-line').addEventListener('click',    ()=> setType('line'));
    document.getElementById('btn-type-candle').addEventListener('click',  ()=> setType('candlestick'));
    document.getElementById('btn-sync').addEventListener('click', ()=> sync(document.getElementById('sel-tf').value));
    document.getElementById('sel-tf').addEventListener('change', (e)=> sync(e.target.value));
    document.getElementById('btn-table').addEventListener('click', ()=> {
      tableModal.show(currentRows);
      tableModal.el.querySelector('#tm-export').onclick = ()=> tableModal.exportCSV();
    });

    // Inicializa
    sync(document.getElementById('sel-tf').value);
  </script>
</body>
</html>