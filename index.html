<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ochart ‚Äî visualizador</title>
  <link rel="icon" href="data:image/svg+xml,
<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22>
  <text x=%224%22 y=%2212%22 font-size=%2212%22>üìà</text>
</svg>">

  <!-- N√∫cleo Chart.js e plugins (UMD) -->
  <script src="./libs/chart.umd.js"></script>
  <script src="./libs/chartjs-adapter-date-fns.bundle.js"></script>
  <script src="./libs/chartjs-chart-financial.min.js"></script>
  <script src="./libs/chartjs-plugin-zoom.min.js"></script>
  <script src="./libs/chartjs-plugin-annotation.min.js"></script>

  <!-- Polimento visual padr√£o do Chart.js (IIFE) -->
  <script src="./js/content.js"></script>

  <!-- Estilos principais do app -->
  <link rel="stylesheet" href="./assets/app.css">
</head>
<body class="ui-surface">

  <section class="box row">
    <div class="inline">
      <label>TF</label>
      <select id="sel-tf">
        <option value="1h">1h</option>
        <option value="1d" selected>1d</option>
        <option value="1w">1w</option>
        <option value="1mo">1mo</option>
      </select>
    </div>

    <div class="inline">
      <label class="muted">Janela (offsets do fim)</label>
      <div id="ow"></div>
    </div>

    <div class="inline">
      <label class="muted">Tipo</label>
      <div class="seg">
        <button id="btn-type-line" class="active">Line</button>
        <button id="btn-type-candle">Candle</button>
      </div>
    </div>

    <div class="inline">
      <label class="muted">Escala</label>
      <div class="seg">
        <button id="btn-scale-linear">Linear</button>
        <button id="btn-scale-log" class="active">Log</button>
      </div>
    </div>

    <div class="spacer"></div>

    <button id="btn-table">üìä Tabela</button>
    <button id="btn-sync">üîÑ Sync</button>
    <button id="btn-theme"><span>üåô</span> Dark</button>
    <span id="status" class="muted">‚Äî</span>
  </section>

  <section class="box" style="height:420px; margin-top:12px">
    <div class="chart-shell">
      <canvas id="ch"></canvas>
    </div>
  </section>

  <section class="box row" style="margin-top:12px">
    <div><div class="muted">Pre√ßo (close)</div><div id="k-close" class="big price-value">‚Äî</div></div>
    <div><div class="muted">M√°x (janela)</div><div id="k-max" class="big price-value">‚Äî</div></div>
    <div><div class="muted">M√≠n (janela)</div><div id="k-min" class="big price-value">‚Äî</div></div>
  </section>

  <div id="dev-hud-root"></div>

  <script type="module">
    import { ChartEngine } from './src/core/chart-engine.js';
    import { mountHUD, pushLog } from './src/ui/dev-hud.js';
    import { sanitizeLine } from './src/core/sanitizer.js';
    import { OffsetWindow } from './src/ui/offset-window.js';
    import { TableModal } from './src/ui/table-modal.js';
    import { DrawingTools } from './src/ui/drawing-tools.js';

    mountHUD(document.getElementById('dev-hud-root'));

    const $ = (sel)=> document.querySelector(sel);
    let engine = null;
    let drawingTools = null;
    let ow = null;
    let fullRows = [];
    let currentRows = [];
    let currentScale = 'logarithmic';
    let currentType  = 'line';
    const tableModal = new TableModal();

    // =========================
    // Tema
    // =========================
    const initTheme = () => {
      const saved = localStorage.getItem('ochart-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', theme);
      const btnTheme = $('#btn-theme');
      if (btnTheme) {
        btnTheme.innerHTML = theme === 'dark'
          ? '<span>‚òÄÔ∏è</span> Light'
          : '<span>üåô</span> Dark';
      }
      return theme;
    };

    const toggleTheme = () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('ochart-theme', next);
      const btnTheme = $('#btn-theme');
      if (btnTheme) {
        btnTheme.innerHTML = next === 'dark'
          ? '<span>‚òÄÔ∏è</span> Light'
          : '<span>üåô</span> Dark';
      }
      pushLog({ level:'info', msg:'theme_change', ts: Date.now(), data:{ theme: next }});
      if (engine && engine.chart) updateChartTheme(next);
    };

    const updateChartTheme = (theme) => {
      if (!engine || !engine.chart) return;
      const isDark = theme === 'dark';
      const chart = engine.chart;
      const opts = chart.options;
      const colors = {
        grid: isDark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.06)',
        text: isDark ? '#9ca3af' : '#6b7280',
        textTitle: isDark ? '#e4e4e7' : '#111827',
        tooltip: {
          bg: isDark ? 'rgba(26, 29, 46, 0.95)' : 'rgba(255, 255, 255, 0.95)',
          border: isDark ? '#2a2d3a' : '#e5e7eb',
          text: isDark ? '#e4e4e7' : '#111827',
          textMuted: isDark ? '#9ca3af' : '#6b7280'
        }
      };
      if (opts.scales?.x?.grid) opts.scales.x.grid.color = colors.grid;
      if (opts.scales?.y?.grid) opts.scales.y.grid.color = colors.grid;
      if (opts.scales?.x?.ticks) opts.scales.x.ticks.color = colors.text;
      if (opts.scales?.y?.ticks) opts.scales.y.ticks.color = colors.text;
      if (opts.plugins?.tooltip) {
        opts.plugins.tooltip.backgroundColor = colors.tooltip.bg;
        opts.plugins.tooltip.borderColor = colors.tooltip.border;
        opts.plugins.tooltip.borderWidth = 1;
        opts.plugins.tooltip.titleColor = colors.tooltip.text;
        opts.plugins.tooltip.bodyColor = colors.tooltip.textMuted;
        opts.plugins.tooltip.padding = 10;
        opts.plugins.tooltip.cornerRadius = 8;
      }
      if (opts.plugins?.legend?.labels) {
        opts.plugins.legend.labels.color = colors.text;
      }
      chart.update('none');
    };

    // Inicializa tema
    initTheme();

    // =========================
    // Utilit√°rios
    // =========================
    function formatPrice(value){
      if (!Number.isFinite(value)) return '‚Äî';
      return Math.round(value).toLocaleString('en-US');
    }

    function mapInterval(tf){
      if (tf === '1h') return '60m';
      if (tf === '1w') return '1wk';
      return tf;
    }
    function requestRange(tf){
      if (tf === '1h')  return '3mo';
      if (tf === '1d')  return 'max';
      if (tf === '1w')  return 'max';
      if (tf === '1mo') return 'max';
      return 'max';
    }

    // =========================
    // Resili√™ncia (PHP -> JSON est√°tico -> Cache local)
    // =========================
    const QS = new URLSearchParams(location.search);
    const STATIC_MODE =
      location.hostname.endsWith('github.io') ||
      location.protocol === 'file:' ||
      QS.get('static') === '1';

    // >>> MAPA ATUALIZADO (aponta para api/cache/*.json)
    const STATIC_MAP = {
      '1h':  './api/cache/BTC-USD_60m_3mo.json',
      '1d':  './api/cache/BTC-USD_1d_max.json',
      '1w':  './api/cache/BTC-USD_1wk_max.json',
      '1mo': './api/cache/BTC-USD_1mo_max.json'
    };
    const staticUrlFor = (tf) => QS.get('file') || STATIC_MAP[tf] || STATIC_MAP['1d'];

    const cacheKey  = (tf) => `ochart:lastPayload:BTC-USD:${tf}`;
    const saveCache = (tf, payload) => { try { localStorage.setItem(cacheKey(tf), JSON.stringify(payload)); } catch(_){} };
    const readCache = (tf) => { try { const r = localStorage.getItem(cacheKey(tf)); return r ? JSON.parse(r) : null; } catch { return null; } };

    async function fetchJSON(url) {
      const res  = await fetch(url, { headers:{ 'Accept':'application/json' }, cache:'no-store' });
      const text = await res.text();
      let json;
      try { json = text ? JSON.parse(text) : null; }
      catch { throw new Error(`JSON malformado em ${url}`); }
      if (!res.ok) throw new Error((json && (json.message || json.error)) || `HTTP ${res.status} em ${url}`);
      if (!json || typeof json !== 'object') throw new Error(`Payload vazio em ${url}`);
      return { json, headers: res.headers };
    }

    async function fetchFromStatic(tf) {
      const url = staticUrlFor(tf);
      const { json } = await fetchJSON(url);
      console.info('%cSTATIC%c ' + url, 'background:#16a34a;color:#fff;padding:2px 6px;border-radius:4px', 'color:inherit');
      json.meta = { ...(json.meta||{}), source:'static', url };
      return json;
    }

    async function fetchFromPHP(tf) {
      const interval = mapInterval(tf);
      const range    = requestRange(tf);
      const pos      = (currentScale === 'logarithmic') ? '1' : '0';
      const url      = `./api/yahoo.php?symbol=BTC-USD&interval=${encodeURIComponent(interval)}&range=${encodeURIComponent(range)}&sanitized=1&pos=${pos}`;
      const { json, headers } = await fetchJSON(url);
      const xCache = (headers.get('X-Cache') || 'API').toUpperCase();
      console.info(`%c${xCache}%c via PHP ‚Ä¢ tf=${tf}`, 'background:#2563eb;color:#fff;padding:2px 6px;border-radius:4px', 'color:inherit');
      json.meta = { ...(json.meta||{}), source:'php' };
      return json;
    }

    async function fetchSeries(tf='1d'){
      const preferStatic = STATIC_MODE;
      const errors = [];

      if (preferStatic) {
        try { const p = await fetchFromStatic(tf); saveCache(tf, p); return p; } catch (e) { errors.push(e); }
        try { const p = await fetchFromPHP(tf);    saveCache(tf, p); return p; } catch (e) { errors.push(e); }
      } else {
        try { const p = await fetchFromPHP(tf);    saveCache(tf, p); return p; } catch (e) { errors.push(e); }
        try { const p = await fetchFromStatic(tf); saveCache(tf, p); return p; } catch (e) { errors.push(e); }
      }

      const cached = readCache(tf);
      if (cached && Array.isArray(cached.data) && cached.data.length) {
        console.warn('Usando cache local (√∫ltimo sucesso).');
        cached.meta = { ...(cached.meta||{}), source:'cache' };
        return cached;
      }

      const msg = 'N√£o foi poss√≠vel carregar dados (PHP/est√°tico/cache).\n' +
                  errors.map((e,i)=>`[${i+1}] ${e.message}`).join('\n');
      throw new Error(msg);
    }

    // =========================
    // Render / Sync
    // =========================
    function sliceByOffsets(rows, finish, start){
      const n = rows.length;
      if(!n) return { data:[], a:0, b:0, left:0, right:0 };
      const max = Math.max(0, n-1);
      const F = Math.min(Math.max(0, finish|0), max);
      const S = Math.min(Math.max(0, start|0), max);
      const left = Math.max(F, S);
      const right = Math.min(F, S);
      const idxStart = (n-1) - left;
      const idxEnd   = (n-1) - right;
      const a = Math.max(0, Math.min(idxStart, idxEnd));
      const b = Math.max(0, Math.max(idxStart, idxEnd));
      return { data:rows.slice(a, b+1), a, b, left, right };
    }

    function render(rows){
      if(!engine){
        engine = new ChartEngine($('#ch'), { bundlesEndpoint: './api/bundles.php' });
        drawingTools = new DrawingTools(engine);
        drawingTools.init();
        const shell = document.querySelector('.chart-shell');
        const tb = document.getElementById('drawing-toolbar');
        if (shell && tb && tb.parentElement !== shell) shell.appendChild(tb);
      }
      engine.create(rows, { type: currentType, scale: currentScale });

      const theme = document.documentElement.getAttribute('data-theme');
      if (theme) updateChartTheme(theme);

      currentRows = rows.slice();

      const last = rows[rows.length-1];
      $('#k-close').textContent = formatPrice(last?.c);
      const highs = rows.map(r=>r.h).filter(Number.isFinite);
      const lows  = rows.map(r=>r.l).filter(Number.isFinite);
      $('#k-max').textContent = highs.length ? formatPrice(Math.max(...highs)) : '‚Äî';
      $('#k-min').textContent = lows.length  ? formatPrice(Math.min(...lows))  : '‚Äî';
    }

    function setScale(scale){
      currentScale = (scale === 'linear') ? 'linear' : 'logarithmic';
      document.getElementById('btn-scale-linear').classList.toggle('active', currentScale==='linear');
      document.getElementById('btn-scale-log').classList.toggle('active', currentScale==='logarithmic');
      if (engine) engine.setScale(currentScale);
      pushLog({ level:'info', msg:'scale_change', ts:Date.now(), data:{ scale:currentScale }});
      const tag = currentScale==='logarithmic' ? 'Log' : 'Linear';
      document.getElementById('status').textContent = `OK (${tag})`;
    }

    function setType(type){
      currentType = (type === 'candlestick') ? 'candlestick' : 'line';
      document.getElementById('btn-type-line').classList.toggle('active', currentType==='line');
      document.getElementById('btn-type-candle').classList.toggle('active', currentType==='candlestick');
      if (engine) engine.setType(currentType);
      pushLog({ level:'info', msg:'chart_type_change', ts:Date.now(), data:{ type:currentType }});
      document.getElementById('status').textContent = `OK (${currentType === 'candlestick' ? 'Candle' : 'Line'})`;
    }

    async function sync(tf){
      document.getElementById('status').textContent = 'Carregando...';
      pushLog({ level:'info', msg:'sync_start', ts:Date.now(), data:{ tf, scale:currentScale }});
      try{
        const payload = await fetchSeries(tf);
        const data = Array.isArray(payload?.data) ? payload.data : [];
        const meta = payload?.meta || {};
        const { data: rows, stats } = sanitizeLine(data, { requirePositive: currentScale==='logarithmic' });
        fullRows = rows;

        if (stats) {
          pushLog({ level:(stats.droppedInvalid>0?'warn':'info'), msg:'sanitize_report_front', ts:Date.now(), data:stats });
        }

        const max = Math.max(0, rows.length-1);
        const ensureOW = ()=>{
          if(!ow){
            ow = new OffsetWindow(document.getElementById('ow'),{
              max, finish:max, start:0,
              onApply:({ max, finish, start })=>{
                const sliced = sliceByOffsets(fullRows, finish, start);
                pushLog({ level:'info', msg:'window_offsets', ts:Date.now(), data:{ max, finish, start, size:sliced.data.length, idxStart:sliced.a, idxEnd:sliced.b }});
                render(sliced.data);
                document.getElementById('status').textContent = `OK (janela: ${sliced.data.length})`;
              }
            });
          }else{
            ow.setMax(max);
            ow.setWindow({ finish:max, start:0 });
          }
        };

        ensureOW();

        const sliced = sliceByOffsets(rows, Math.max(0, rows.length-1), 0);
        render(sliced.data);

        const src = meta?.source || (meta?.sanitized ? 'php' : 'static');
        document.getElementById('status').textContent = `OK (${currentScale==='logarithmic'?'Log':'Linear'} | fonte: ${src})`;
        pushLog({ level:'info', msg:'sync_ok', ts:Date.now(), data:{ bars:rows.length, scale:currentScale, source: src }});
      }catch(e){
        console.error(e);
        document.getElementById('status').textContent = 'Falha';
        pushLog({ level:'error', msg:'sync_fail', ts:Date.now(), data:{ error:String(e) }});
        alert('Erro: ' + e.message);
      }
    }

    // Handlers
    document.getElementById('btn-scale-linear').addEventListener('click', ()=> setScale('linear'));
    document.getElementById('btn-scale-log').addEventListener('click',    ()=> setScale('logarithmic'));
    document.getElementById('btn-type-line').addEventListener('click',    ()=> setType('line'));
    document.getElementById('btn-type-candle').addEventListener('click',  ()=> setType('candlestick'));
    document.getElementById('btn-sync').addEventListener('click', ()=> sync(document.getElementById('sel-tf').value));
    document.getElementById('sel-tf').addEventListener('change', (e)=> sync(e.target.value));
    document.getElementById('btn-table').addEventListener('click', ()=> {
      tableModal.show(currentRows);
      tableModal.el.querySelector('#tm-export').onclick = ()=> tableModal.exportCSV();
    });
    document.getElementById('btn-theme').addEventListener('click', toggleTheme);

    // Inicializa
    sync(document.getElementById('sel-tf').value);
  </script>
</body>
</html>
